name: PrefetchDB

on:
  push:
    branches:
      - "**"
  schedule:
    # * is a special character in YAML so you have to quote this string
    # At 01:00 on Sunday, Tuesday, and Thursday.
    - cron:  '0 1 * * 0,2,4'


jobs:
  collect-db-job:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17
      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2
      - name: Cache previous DorisDB prefetch # https://github.com/actions/cache/blob/main/tips-and-workarounds.md#update-a-cache
        uses: actions/cache@v3
        with:
          path: DorisAndroidPrefetch/run/database
          key: dorisdb-cache-${{ runner.OS }}-${{ github.run_id }}
          restore-keys: |
            dorisdb-cache-${{ runner.OS }}
      - name: Show Cache Content
        run: |
          set +e
          sudo apt-get update -yq
          sudo apt-get install -yq sqlite3
          pwd
          ls -lsa DorisAndroidPrefetch/run
          ls -lsa DorisAndroidPrefetch/run/database
          if [ -f DorisAndroidPrefetch/run/database/DorisAndroid.db ]; then
            sqlite3 DorisAndroidPrefetch/run/database/DorisAndroid.db ".tables"
            sqlite3 DorisAndroidPrefetch/run/database/DorisAndroid.db "SELECT * FROM dorisDB_metadata;"
          fi
          ls -lsa $HOME/.gradle
          set -e
      - name: Get DB from Doris web site 🕸️
        run: |
          echo "Get DB from Doris web site"
          ./gradlew buildDorisDB -Pargs="-u ${{ secrets.DORIS_SITE_USER_ID }} --token=${{ secrets.DORIS_SITE_ACCESS_TOKEN }} --max=500"
      - name: Report warnings/errors 🔍
        run: |
          echo "### Database prefetch summary :inbox_tray:" >> $GITHUB_STEP_SUMMARY
          grep ' WARN - ' DorisAndroidPrefetch/run/prefetch_debug.log > DorisAndroidPrefetch/run/prefetch_warn.log || true
          grep ' ERROR - ' DorisAndroidPrefetch/run/prefetch_debug.log > DorisAndroidPrefetch/run/prefetch_error.log || true
          if [ -s  DorisAndroidPrefetch/run/prefetch_warn.log ]; then
            echo "::warning file=DorisAndroidPrefetch/src/main/java/fr/ffessm/doris/prefetch/PrefetchDorisWebSite.java::`tail -n 5 DorisAndroidPrefetch/run/prefetch_warn.log`"
            echo ":warning: Partial prefetch" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            tail -n 5 DorisAndroidPrefetch/run/prefetch_warn.log  >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -s  DorisAndroidPrefetch/run/prefetch_error.log ]; then
            echo "::error file=DorisAndroidPrefetch/src/main/java/fr/ffessm/doris/prefetch/PrefetchDorisWebSite.java::`tail -n 5 DorisAndroidPrefetch/run/prefetch_error.log`"
            echo ":x: Error in prefetch" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            tail -n 5 DorisAndroidPrefetch/run/prefetch_error.log  >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
          echo "Database content:" >> $GITHUB_STEP_SUMMARY
          scripts/dbMarkdownSummary.sh DorisAndroidPrefetch/run/database/DorisAndroid.db >> $GITHUB_STEP_SUMMARY

      - name: Archive Artifacts
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: doris-db-artifacts
          path: |
            DorisAndroidPrefetch/run/
            !DorisAndroidPrefetch/run/images
